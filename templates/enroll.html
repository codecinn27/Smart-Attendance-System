<!DOCTYPE html>
<html>
<head>
  <title>{{ title }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui/dist/semantic.min.css">
</head>
<body>
  <div class="ui menu">
    <a class="item" href="/">Home</a>
    <a class="item" href="/enroll">Enroll</a>
    <a class="item" href="/recognize">Recognize</a>
    <a class="item" href="/records">Records</a>
  </div>

  <div class="ui container">
    <h1 class="ui header">{{ title }}</h1>
    <p>Welcome to the {{ title }} page.</p>
    <div class="ui segment">
      <form class="ui form" method="post" action="/enroll">
        <div class="field">
          <label>Student Name</label>
          <input type="text" name="name" placeholder="Enter student name" required>
        </div>

        <div class="field">
          <label>Age</label>
          <input type="number" name="age" placeholder="Enter age" min="5" required>
        </div>

        <div class="field">
          <label>Enrolled Classes</label>
          <div class="ui checkbox">
            <input type="checkbox" name="enrolled_classes" value="Mathematics">
            <label>Mathematics</label>
          </div><br>
          <div class="ui checkbox">
            <input type="checkbox" name="enrolled_classes" value="Science">
            <label>Science</label>
          </div><br>
          <div class="ui checkbox">
            <input type="checkbox" name="enrolled_classes" value="English">
            <label>English</label>
          </div>
        </div>

        <button class="ui primary button" type="submit">Submit Enrollment</button>
      </form>
    </div>
    

    <div class="ui segment" id="webcam-container" style="display:none;">
      <video id="webcam" width="640" height="480" autoplay playsinline></video>
      <img id="annotated-stream" width="640" height="480" alt="Annotated Stream" style="margin-top: 10px; border: 1px solid #ccc;" />
    </div>
    
  </div>

  <!-- <script>
    function openWebcam() {
      const video = document.getElementById('webcam');
      const container = document.getElementById('webcam-container');

      container.style.display = 'block';  // Show video container

      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then((stream) => {
            video.srcObject = stream;
            video.play();
          })
          .catch((err) => {
            alert('Could not access webcam: ' + err);
          });
      } else {
        alert('getUserMedia not supported in this browser.');
      }
    }

    function stopWebcam() {
      const video = document.getElementById('webcam');
      const stream = video.srcObject;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      video.srcObject = null;

      document.getElementById('webcam-container').style.display = 'none';
    }

    // Call openWebcam if name param exists (start webcam on page load)
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const enrolledName = urlParams.get('name');
      if (enrolledName) {
        openWebcam();
        startFaceCapture(enrolledName);
      }
    });

  </script> -->

  <script>
    let ws;
    let captureCount = 0;

    function startFaceCapture(studentName) {
      if (ws) {
        ws.close();
      }

      ws = new WebSocket(`ws://${location.host}/ws/enroll_capture/${studentName}`);

      ws.onopen = () => {
        console.log('WebSocket connected');
        document.getElementById('webcam-container').style.display = 'block';
        captureCount = 0;
        sendFrameLoop();
      };

      ws.onmessage = (event) => {
        const msg = event.data;

        if (msg.startsWith('captured:')) {
          captureCount = parseInt(msg.split(':')[1]);
          console.log(`Captured image ${captureCount}`);
        } else if (msg === 'done') {
          alert('Face capture completed!');
          ws.close();
          document.getElementById('webcam-container').style.display = 'none';
        } else if (msg === 'no_face') {
          console.log('No face detected in frame');
        } else if (msg.startsWith('data:image/jpeg;base64,')) {
          // Display annotated frame with bounding box
          document.getElementById('annotated-stream').src = msg;
        }
      };

      ws.onclose = () => {
        console.log('WebSocket closed');
      };
    }

    function openWebcamAndCapture() {
      const video = document.createElement('video');
      video.autoplay = true;
      video.playsInline = true;

      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then((stream) => {
            video.srcObject = stream;
            video.play();
            window.localVideoStream = stream;  // Save stream globally for stopping later
            window.localVideo = video;          // Save video element globally
            sendFrameLoop();
          })
          .catch((err) => {
            alert('Could not access webcam: ' + err);
          });
      } else {
        alert('getUserMedia not supported in this browser.');
      }
    }

    function stopWebcam() {
      if (window.localVideoStream) {
        window.localVideoStream.getTracks().forEach(track => track.stop());
      }
      window.localVideoStream = null;
      window.localVideo = null;
      document.getElementById('webcam-container').style.display = 'none';
    }

    function sendFrameLoop() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      if (!window.localVideo) {
        console.warn('Video not ready yet');
        setTimeout(sendFrameLoop, 100);
        return;
      }

      const video = window.localVideo;
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataURL = canvas.toDataURL('image/jpeg');

      ws.send(dataURL);
      setTimeout(sendFrameLoop, 200);
    }

    // On page load, start face capture if name param exists
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const enrolledName = urlParams.get('name');
      if (enrolledName) {
        ws = new WebSocket(`ws://${location.host}/ws/enroll_capture/${enrolledName}`);

        ws.onopen = () => {
          console.log('WebSocket connected');
          document.getElementById('webcam-container').style.display = 'block';
          captureCount = 0;
          openWebcamAndCapture();
        };

        ws.onmessage = (event) => {
          const msg = event.data;

          if (msg.startsWith('captured:')) {
            captureCount = parseInt(msg.split(':')[1]);
            console.log(`Captured image ${captureCount}`);
          } else if (msg === 'done') {
            alert('Face capture completed!');
            ws.close();
            stopWebcam();
          } else if (msg === 'no_face') {
            console.log('No face detected in frame');
          } else if (msg.startsWith('data:image/jpeg;base64,')) {
            document.getElementById('annotated-stream').src = msg;
          }
        };

        ws.onclose = () => {
          console.log('WebSocket closed');
        };
      }
    });
  </script>


</body>
</html>
